$().ready(function(){npdc={alert:function(t){$("#overlay .inner").addClass("box").text(t),$("#overlay .inner").append('<br/><br/><button onclick="npdc.close();">OK</button>'),$("#overlay").fadeIn(100,function(){$(window).on("keyup",function(t){var o=t.keyCode||t.which;13!==o&&27!==o||npdc.close()})})},confirm:function(t,o,e,a,n){a="undefined"==typeof a?"OK":a,n="undefined"==typeof n?"Cancel":n,$("#overlay .inner").addClass("box").text(t),$("#overlay .inner").append('<br/><br/><button id="trueButton">'+a+'</button> <button id="falseButton">'+n+"</button>"),$("#overlay .inner.box button").on("click",function(){npdc.close()}),$("#trueButton").on("click",o),null!==e&&$("#falseButton").on("click",e),$("#overlay").fadeIn(100,function(){$(window).on("keyup",function(t){var a=t.keyCode||t.which;13===a&&(npdc.close(),o()),27===a&&(npdc.close(),null!==e&&e())})})},close:function(t){$(window).off("keyup"),$("#overlay").fadeOut(100,function(){$("#overlay .inner").removeClass("box").text("")})}},lookup={add:function(t){t.data("newCount",t.data("newCount")+1),suffix="_"+t.data("newCount"),t.find("[id$=_new]").each(function(){$(this).attr("id",$(this).attr("id")+suffix)}),t.find("[name$=_new\\[\\]]").each(function(){$(this).attr("name",$(this).attr("name").slice(0,-2)+suffix+"[]")}),t.find("[name$=_new]").each(function(){$(this).attr("name",$(this).attr("name")+suffix)}),t.find("[for$=_new]").each(function(){$(this).attr("for",$(this).attr("for")+suffix)}),t.find("#"+t.data("newRowBaseId")+suffix+" td:nth-child(2)").click(function(){lookup.delete($(this).parent().attr("id"))}),clone=t.data("clone"),t.data("clone",clone.clone()),clone.insertAfter($("#"+t.data("newRowBaseId")+suffix)),$("#"+t.data("newRowBaseId")+" select:not(.no-select2):not(.select2-hidden-accessible)").each(function(){makeSelect2(this)}),t.hasClass("lookuptable")&&initialize.lookuptable(clone)},delete:function(t){var o=$("#"+t).parents("table"),e=$("#"+t).find("td:nth-of-type("+o.attr("data-n-label")+")").find("input");e.parents("form");npdc.confirm("Do you want to delete "+e.val()+" here?",function(){$("#"+t).remove()},null,"Yes, delete","No, keep")},updateField:function(t){tbl=$(t).parents("table"),l-1===lookup.cur&&void 0!==$(t).parents("table").attr("data-new-url")?(name=$(t).text().substring(4),$("#overlay .inner").html('<iframe src="'+$(t).parents("table").attr("data-new-url")+"/"+name+'"></iframe>'),$("#overlay").show(),$("form :input").prop("disabled",!0),$("#overlay").data("element",tbl),$("#overlay").data("type","lookupfield")):this.saveOption(tbl,$(t).attr("value"),$(t).text(),$(t).attr("data-nextfield"))},saveOption:function(t,o,e,a){if(t.hasClass("single"))$(t).data("lookupfield").val(e).attr("readonly","readonly").addClass("readonly").siblings("input[type=hidden]").val(o),t.data("lookupfield").off("keyup keydown focus");else{if($("[name="+t.attr("data-source-field")+"_new]").val(e).attr("readonly","readonly").addClass("readonly"),$("[name="+t.attr("data-target-field")+"_new]").val(o),t.data("lookupfield").off("keyup keydown focus"),void 0!==$("[name="+t.attr("data-source-field")+"_new]").attr("data-onsubmit")&&void 0!==a){var n=$("[name="+t.attr("data-source-field")+"_new]").attr("data-onsubmit");void 0!==$("[name="+n+"_new]").attr("data-ajax-url")&&($("[name="+n+"_new]").addClass("ajax-target"),$.get($("[name="+n+"_new]").attr("data-ajax-url")+"/"+a,function(t){$(".ajax-target").append($("<option>",{value:t[0][0]}).text(t[0][1].replace("&amp;","&"))),$(".ajax-target").val(a).trigger("change"),$(".ajax-target").removeClass("ajax-target")})),$("[name="+n+"_new]").val(a).trigger("change")}lookup.add(t)}$("#optionwrapper").remove(),form=$(t).parents("form")},selectOption:function(t,o){if(o="undefined"!=typeof o&&o,clearTimeout(lookup.timer),fullString=$(t).attr("data-self"),$(t).hasClass("notSelected"))for($("#optionwrapper div").removeClass("clicked").addClass("notSelected hidden"),$("#optionwrapper :not([data-parent])").removeClass("hidden"),$(t).removeClass("notSelected hidden"),testElement=t;$(testElement).is("[data-parent]");)$('[data-parent="'+$(testElement).attr("data-parent")+'"]').removeClass("hidden"),testElement='[data-self="'+$(testElement).attr("data-parent")+'"]',$(testElement).removeClass("notSelected").addClass("clicked");if($(t).hasClass("clicked")||0===$('div[data-parent="'+fullString+'"]').length||o){if(void 0===$(t).attr("data-parent"))$(t).text($(t).text());else{truncated=[],$(t).attr("data-parent").split(">").forEach(function(t){t.trim().length>12?truncated.push(t.trim().substring(0,10)+"..."):truncated.push(t.trim())});var e=$(t).text().trim();lof=e.lastIndexOf(">"),lof>-1&&(e=e.substring(lof).trim()),$(t).text(truncated.join(" > ")+" "+e)}lookup.updateField(t)}else $(t).addClass("clicked"),$(t).siblings(":not(.clicked)").addClass("notSelected"),$('[data-parent="'+fullString+'"]').removeClass("hidden notSelected"),lookup.scrollOptionwrapper(!0)},positionOptionwrapper:function(){$("#optionwrapper").length>0&&($("#optionwrapper").prev("input").offset().top-$("body").scrollTop()>$(window).height()/2?($("#optionwrapper").css("max-height",$("#optionwrapper").prev("input").offset().top-$("body").scrollTop()).css("bottom",$("#optionwrapper").parent().height()),$("#optionwrapper").addClass("above")):($("#optionwrapper").css("max-height",$(window).height()-30-($("#optionwrapper").prev("input").offset().top-$("body").scrollTop())).css("bottom","auto"),$("#optionwrapper").removeClass("above")))},scrollOptionwrapper:function(t){lookup.cur!==-1&&(t?$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-15):$("#option_"+lookup.cur).position().top<0?$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-15):$("#option_"+lookup.cur).position().top>$("#option_"+lookup.cur).parent().height()-30&&$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-$("#option_"+lookup.cur).parent().height()+40))}},initialize={lookuptable:function(t,o){if(o)var e=$(t).find("input[type=text]");else var e=$("input[name="+t.parents("table").attr("data-source-field")+"_new]");e.parents("table").find(".lookupwrapper").removeClass("lookupwrapper"),e.parent().addClass("lookupwrapper"),e.cur=null,e.parents("table").data("lookupfield",e),e.on("keydown keyup focus paste",function(t){var o=t.keyCode||t.which;if((13===o||9===o||"keydown"!==t.type)&&(13!==o&&9!==o||"keyup"!==t.type)){var a=e.val();if(a!==e.cur){if($("#optionwrapper").remove(),a.length>=2,!0){var n="data.php?q="+a;$("[name^="+e.parents("table").attr("data-target-field")+"]").each(function(){""!==$(this).val()&&(n+="&e[]="+$(this).val())}),$.ajax(n,"json").done(function(t){a===e.val()&&($("#optionwrapper").remove(),optionlist=[],options='<div id="optionwrapper" class="options"></div>',e.after(options),lookup.positionOptionwrapper(),l=t.length,lookup.data=t,lookup.cur=-1,l>0?$.each(t,function(t,o){displayValue=o[1],parent=o[1].substring(0,o[1].lastIndexOf(">")).trim(),e.cur.length>0?displayValue=o[1].replace(new RegExp("("+e.cur+")","gi"),"<mark>$1</mark>"):0===parent.length?parent=void 0:displayValue=(o[1].match(/>/g).join("").replace(/>/g,"   ")||[])+o[1].substring(o[1].lastIndexOf(">")).trim();var a=$("<div>").html(displayValue).attr("id","option_"+t).attr("value",o[0]).attr("data-parent",parent).attr("data-self",o[1]);o.length>2&&a.attr("data-nextfield",o[2]),$("#optionwrapper").append(a)}):$("#optionwrapper").append($("<div>").html("<i>No results found</i>")),void 0!==$("#optionwrapper").parents("table").attr("data-new-url")&&($("#optionwrapper").append($("<div>").html("<i>Add "+$("#optionwrapper").siblings("input").val()+"</i>").attr("id","option_"+l).attr("value","new")),l+=1),$("#optionwrapper div[value]").on("mouseenter",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus")}),0===a.length?($("#optionwrapper div[data-parent]").addClass("hidden"),$("#optionwrapper div").on("click",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.selectOption(this),$("#optionwrapper").prev("input").focus()}).on("mousedown",function(t){t.preventDefault()})):$("#optionwrapper div[value]").off("click").on("click",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.selectOption(this,!0)}).on("mousedown",function(t){t.preventDefault()}))})}e.cur=a}else switch(o){case 40:return t.preventDefault(),lookup.cur===-1?lookup.cur=0:(nextId=$("#optionwrapper div:not(.hidden)").eq($("#optionwrapper div:not(.hidden)").index($(".optionHasFocus"))+1).attr("id"),void 0===nextId?lookup.cur=-1:lookup.cur=Number(nextId.substr(nextId.lastIndexOf("_")+1))),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.scrollOptionwrapper(),!1;case 38:return t.preventDefault(),lookup.cur===-1?(prevId=$("#optionwrapper div:not(.hidden)").last().attr("id"),lookup.cur=Number(prevId.substr(prevId.lastIndexOf("_")+1))):(prevId=$("#optionwrapper div:not(.hidden)").eq($("#optionwrapper div:not(.hidden)").index($(".optionHasFocus"))-1).attr("id"),0===$("#optionwrapper :not(.hidden)").index($(".optionHasFocus"))?lookup.cur=-1:lookup.cur=Number(prevId.substr(prevId.lastIndexOf("_")+1))),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.scrollOptionwrapper(),!1;case 13:case 9:t.preventDefault(),lookup.cur>-1&&lookup.selectOption($("#option_"+lookup.cur));break;case 27:lookup.doBlur()}}}),lookup.doBlur=function(){if(document.hasFocus())if("undefined"!=typeof $("#optionwrapper").siblings("input").val()&&$("#optionwrapper").siblings("input").val().length>0){var t="Please select a value from the options";void 0!==$("#optionwrapper").parents("table").attr("data-new-url")&&(t+=" or use the add new option"),npdc.confirm(t,function(){setTimeout(function(){$("#optionwrapper").siblings("input").focus()},100)},function(){$("#optionwrapper").siblings("input").val(""),$("#optionwrapper").hide()},"Continue selecting","Cancel and remove input")}else $("#optionwrapper").hide()},e.blur(function(){lookup.timer=setTimeout(function(){lookup.doBlur()},10)}),e.focus(function(){$("#optionwrapper").show(),lookup.positionOptionwrapper()})}},$(".lookuptable,.multivalue").each(function(){var t=!1;if($(this).hasClass("single")){var o=$(this).find("td");t=!0}else{$(this).data("newRowBaseId",$(this).find("[id$=_row_new]").attr("id")),$(this).data("clone",$("#"+$(this).data("newRowBaseId")).clone()),$(this).data("newCount",0),$(this).find("[id*=_row_new_]").each(function(){var t=parseInt($(this).attr("id").substring($(this).attr("id").lastIndexOf("_")+1));t>$(this).parents("table").data("newCount")&&$(this).parents("table").data("newCount",t)});var o=$(this).find("[id$=_row_new]")}$(this).hasClass("lookuptable")&&initialize.lookuptable(o,t)}),$(window).on("scroll resize",function(){lookup.positionOptionwrapper()})});